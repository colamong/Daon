# .gitlab-ci.yml — BE(도커) + FE(정적배포), deploy 브랜치 전용

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "deploy"'
    - when: never

stages: [build_be, deploy_be, build_fe, package_fe, deploy_fe]

default:
  interruptible: true
  tags: ["daon"]  # 모든 잡을 EC2 Shell 러너에서 실행

.ssh_setup: &ssh_setup
  - mkdir -p ~/.ssh
  - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
  - chmod 600 ~/.ssh/id_rsa
  - ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

# ===== Backend =====

build-and-push-be:
  stage: build_be
  rules:
    - if: '$CI_COMMIT_BRANCH == "deploy"'
      changes:
        - BE/**/*
  before_script:
    - docker -v
  script:
    - echo "=== Docker Hub Login ==="
    - docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_TOKEN"
    - echo "=== Docker Build ==="
    - docker build -t junwoooo/daon:latest BE
    - echo "=== Docker Push ==="
    - docker push junwoooo/daon:latest

deploy-backend:
  stage: deploy_be
  needs: ["build-and-push-be"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "deploy"'
      changes:
        - BE/**/*
  script:
    - set -euxo pipefail
    # 네트워크 없으면 생성 (idempotent)
    - docker network inspect daon-network >/dev/null 2>&1 || docker network create daon-network
    # 기존 컨테이너 정리
    - docker stop daon-app || true
    - docker rm daon-app || true
    # 최신 이미지 풀
    - docker pull junwoooo/daon:latest
    # .env 존재 확인
    - test -f .env
    # 새 컨테이너 실행 (백슬래시 없이 한 줄)
    - docker run -d --name daon-app --network daon-network --env-file .env -p 8080:8080 --restart=always junwoooo/daon:latest
    # (옵션) 배포 직후 이름해석 확인
    - docker exec daon-app getent hosts redis || true

# ===== Frontend =====

build-fe:
  stage: build_fe
  rules:
    - if: '$CI_COMMIT_BRANCH == "deploy"'
      changes:
        - FE/my-vue-app/**/*
  before_script:
    - node -v
    - npm -v
  cache:
    key: fe-${CI_COMMIT_REF_SLUG}
    paths:
      - FE/my-vue-app/node_modules/
  script:
    - cd FE/my-vue-app
    - npm ci
    - npm run build
  artifacts:
    paths:
      - FE/my-vue-app/dist/
    expire_in: 1 week

package-fe:
  stage: package_fe
  needs: ["build-fe"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "deploy"'
      changes:
        - FE/my-vue-app/**/*
  before_script:
    - tar --version
  script:
    - export RELEASE="${CI_PIPELINE_IID}-${CI_COMMIT_SHORT_SHA}"
    - tar -czf "dist-${RELEASE}.tar.gz" -C FE/my-vue-app/dist .
    - echo "${RELEASE}" > RELEASE.txt
  artifacts:
    paths:
      - dist-*.tar.gz
      - RELEASE.txt
    expire_in: 1 week

deploy-frontend:
  stage: deploy_fe
  needs: ["package-fe"]
  environment:
    name: production
    url: https://i13a706.p.ssafy.io
  rules:
    - if: '$CI_COMMIT_BRANCH == "deploy"'
      changes:
        - FE/my-vue-app/**/*
  before_script:
    - *ssh_setup
    - export RELEASE=$(cat RELEASE.txt)
    - export TARGET="${SSH_TARGET_DIR}"
    - export RELEASE_DIR="${TARGET}/releases/${RELEASE}"
  script:
    # 1) 서버에 릴리스 폴더 생성
    - ssh ${SSH_USER}@${SSH_HOST} "mkdir -p '${RELEASE_DIR}'"
    # 2) FE 아티팩트 업로드
    - scp dist-${RELEASE}.tar.gz ${SSH_USER}@${SSH_HOST}:"${RELEASE_DIR}/"
    # 3) 서버에서 압축 해제 및 원본 삭제
    - ssh ${SSH_USER}@${SSH_HOST} "cd '${RELEASE_DIR}' && tar -xzf dist-${RELEASE}.tar.gz && rm dist-${RELEASE}.tar.gz"
    # 4) current 심볼릭 링크 스위칭
    - ssh ${SSH_USER}@${SSH_HOST} "ln -sfn '${RELEASE_DIR}' '${TARGET}/current'"
    # 5) Nginx 검사 및 재시작
    - ssh ${SSH_USER}@${SSH_HOST} "sudo nginx -t && sudo systemctl reload nginx"
  allow_failure: false
