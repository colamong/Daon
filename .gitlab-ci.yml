default:
  tags: ["daon"]

stages:
  - build
  - deploy

# 1) 이미지 빌드 + 푸시 (Docker Hub)
build-and-push:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "deploy"'
  script:
    - echo "=== Docker Hub Login ==="
    - docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_TOKEN"

    - echo "=== Docker Build ==="
    - docker build -t "$IMAGE_NAME:latest" "$BACKEND_DIR"

    - echo "=== Docker Push ==="
    - docker push "$IMAGE_NAME:latest"

# 2) EC2(현재 러너가 있는 곳)에서 컨테이너 교체
deploy-backend:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "deploy"'
  script:
    - whoami && hostname
    - docker version && docker ps
    - echo "=== Stop & Remove existing container (if any) ==="
    - docker stop "$CONTAINER_NAME" || true
    - docker rm "$CONTAINER_NAME" || true

    - echo "=== Pull latest image ==="
    - docker pull "$IMAGE_NAME:latest"

    - echo "=== Run new container ==="
    - docker run -d --name "$CONTAINER_NAME" \
      --env-file "$ENV_FILE" \
      -p "$HOST_PORT:$CONTAINER_PORT" \
      "$IMAGE_NAME:latest"

    - echo "=== Deployment Finished ==="
