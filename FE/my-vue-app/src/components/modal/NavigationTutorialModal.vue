<template>
  <div v-if="modelValue">
    <!-- Ïò§Î≤ÑÎ†àÏù¥ -->
    <div
      class="fixed inset-0 bg-black bg-opacity-50 z-40"
      style="pointer-events: none"
    ></div>

    <!-- BaseModal Ïä§ÌÉÄÏùºÏùÑ Îî∞Ïò® Ïª§Ïä§ÌÖÄ Î™®Îã¨ (Ïò§Î≤ÑÎ†àÏù¥ ÏóÜÏùå) -->
    <div
      class="mt-10 fixed inset-0 flex items-center justify-center z-50 font-paper"
      style="pointer-events: none"
    >
      <div
        class="bg-white rounded-xl overflow-hidden shadow-lg max-w-3xl w-full min-w-[750px] min-h-[550px]"
        style="pointer-events: auto"
        @click.stop
      >
        <!-- Ìó§Îçî -->
        <div
          class="flex items-center justify-between px-4 py-2 bg-blue-100 border-b border-blue-200"
        >
          <h3 class="text-lg font-semibold text-gray-800">
            {{ currentStepData.title }} - Ïù¥Ïö© Í∞ÄÏù¥Îìú
          </h3>
          <!-- Ïª®Ìä∏Î°§ Î≤ÑÌäºÎì§ -->
          <div class="flex gap-3">
            <button
              class="tutorial-btn px-4 py-2 border-none rounded-lg cursor-pointer text-sm bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              :disabled="currentStep === 0"
              @click="previousStep"
            >
              Ïù¥Ï†Ñ
            </button>
            <button
              class="tutorial-btn px-4 py-2 border-none rounded-lg cursor-pointer text-sm bg-gradient-to-r from-purple-500 to-purple-700 text-white hover:from-purple-600 hover:to-purple-800 hover:transform hover:-translate-y-0.5 hover:shadow-lg transition-all"
              @click="nextStep"
            >
              {{ currentStep === tutorialSteps.length - 1 ? "ÏôÑÎ£å" : "Îã§Ïùå" }}
            </button>
            <button
              class="tutorial-btn px-4 py-2 border-none rounded-lg cursor-pointer text-sm bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors"
              @click="skipTutorial"
            >
              Í±¥ÎÑàÎõ∞Í∏∞
            </button>
          </div>
        </div>

        <!-- Î≥∏Î¨∏ -->
        <div class="p-4">
          <!-- ÏßÑÌñâ ÌëúÏãúÍ∏∞ -->
          <div class="tutorial-progress flex justify-between items-center mb-6">
            <div class="progress-dots flex gap-2">
              <div
                v-for="(step, index) in tutorialSteps"
                :key="index"
                class="progress-dot w-3 h-3 rounded-full transition-colors"
                :class="index <= currentStep ? 'bg-purple-500' : 'bg-gray-300'"
              ></div>
            </div>
            <div class="progress-text text-sm text-gray-500">
              {{ currentStep + 1 }}/{{ tutorialSteps.length }}
            </div>
          </div>

          <!-- Ïù¥ÎØ∏ÏßÄ/GIF ÏòÅÏó≠ -->
          <div class="tutorial-image mb-4 flex justify-center">
            <div
              class="w-full bg-gray-100 rounded-lg p-4 flex items-center justify-center"
            >
              <img
                v-if="currentStepData.image"
                :src="currentStepData.image"
                :alt="currentStepData.title"
                class="w-full h-80 object-contain rounded-md"
              />
              <div
                v-else
                class="w-full h-80 bg-gradient-to-br from-purple-400 to-purple-600 rounded-md flex items-center justify-center text-white text-6xl"
              >
                {{ currentStepData.icon }}
              </div>
            </div>
          </div>

          <!-- ÏòàÏãú -->
          <div
            class="tutorial-example bg-purple-50 p-4 rounded-lg text-base text-gray-700 border-l-4 border-purple-500 mb-6 transition-all duration-500 ease-in-out flex justify-between items-start gap-3"
          >
            <div class="flex-1">
              {{ currentExample }}
            </div>
            <!-- ÏòàÏãú ÌÖçÏä§Ìä∏ Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ -->
            <div
              v-if="
                Array.isArray(currentStepData.example) &&
                currentStepData.example.length > 1
              "
              class="flex-shrink-0 bg-white text-xs text-gray-500 px-2 py-1 rounded-full border border-gray-200 shadow-sm"
            >
              {{ currentExampleIndex + 1 }}/{{ currentStepData.example.length }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted, nextTick } from "vue";
import IconButton from "@/components/button/IconButton.vue";

const props = defineProps({
  modelValue: {
    type: Boolean,
    default: false,
  },
});

const emit = defineEmits(["update:modelValue"]);

// ÌäúÌÜ†Î¶¨Ïñº Ïä§ÌÖù Îç∞Ïù¥ÌÑ∞
const tutorialSteps = [
  {
    target: '[data-tutorial="penguin"]',
    title: "Ìé≠Íµ¨Îûë ÎÜÄÏûê",
    icon: "üéÆ",
    description:
      "Ïû¨ÎØ∏ÏûàÎäî Í≤åÏûÑÍ≥º ÎÜÄÏù¥Î•º ÌÜµÌï¥ ÏïÑÏù¥Îì§Ïù¥ Ï¶êÍ≤ÅÍ≤å ÌïôÏäµÌï† Ïàò ÏûàÎäî Í≥µÍ∞ÑÏûÖÎãàÎã§.",
    example: [
      "‚ö†Ô∏è Ìé≠Íµ¨Îûë ÎÜÄÏûêÎäî ÏïÑÏù¥Í∞Ä Îì±Î°ùÎêòÏñ¥Ïïº Ìï† Ïàò ÏûàÏäµÎãàÎã§.",
      "üêß Ìé≠Í∑ÑÍ≥º ÎåÄÌôîÎ•º ÌÜµÌï¥ ÏïÑÏù¥Îì§Ïù¥ Ï¶êÍ≤ÅÍ≤å ÌïòÎ£®Î•º Í∏∞Î°ùÌï©ÎãàÎã§.",
      "üñºÔ∏è ÏïÑÏù¥Ïùò ÌïòÎ£®Î•º Í∑∏Î¶ºÏúºÎ°ú ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî.",
    ],
    image: "/src/assets/images/pet.gif",
  },
  {
    target: '[data-tutorial="profile"]',
    title: "ÏïÑÏù¥ ÌîÑÎ°úÌïÑ",
    icon: "üë§",
    description:
      "ÏûêÎÖÄÏùò ÌïôÏäµ ÌòÑÌô©, Í¥ÄÏã¨ÏÇ¨, ÏÑ±Ïû• Í∏∞Î°ùÏùÑ Í¥ÄÎ¶¨Ìï† Ïàò ÏûàÎäî Í∞úÏù∏ÌôîÎêú Í≥µÍ∞ÑÏûÖÎãàÎã§.",
    example: [
      "üí° ÏïÑÏù¥Î•º Îì±Î°ùÌïòÍ≥† ÏïÑÏù¥Ïùò ÌôúÎèôÏùÑ Í∏∞Î°ùÌïòÍ≥† Í¥ÄÏ∞∞ÌïòÏÑ∏Ïöî.",
      "üìà ÏïÑÏù¥Ïùò ÌôúÎèôÏùÑ ÌôïÏù∏ÌïòÍ≥† ÏÜåÌÜµÌï¥Î≥¥ÏÑ∏Ïöî",
      "‚öôÔ∏è ÏïÑÏù¥Ïùò Í¥ÄÏã¨ÏÇ¨Ïóê ÎßûÎäî ÎßûÏ∂§ ÏÑ§Ï†ïÏùÑ Ìï† Ïàò ÏûàÏäµÎãàÎã§.",
    ],
    image: "/src/assets/images/child_register.gif",
  },
  {
    target: '[data-tutorial="document"]',
    title: "Î¨∏ÏÑú ÎèÑÏö∞ÎØ∏",
    icon: "üìù",
    description:
      "ÏàôÏ†úÎÇò Í≥ºÏ†úÎ•º ÎèÑÏôÄÏ£ºÎäî AI ÎèÑÍµ¨Î°ú, Í∏ÄÏì∞Í∏∞Î∂ÄÌÑ∞ Î¨∏Ï†ú ÌíÄÏù¥ÍπåÏßÄ ÏßÄÏõêÌï©ÎãàÎã§.",
    example: [
      "üí° Ïñ¥Î†§Ïö¥ Î¨∏ÏÑúÎ•º Î≤àÏó≠Ìï¥Î≥¥ÏÑ∏Ïöî.",
      "üìù Í∞ÄÏ†ïÌÜµÏã†Î¨∏Î∂ÄÌÑ∞ Îã§ÏñëÌïú Í≥µÎ¨∏ÏÑúÍπåÏßÄ.",
      "ü§ñ Î≤àÏó≠Í≥º ÏöîÏïΩÏùÑ ÌïúÎ≤àÏóê!.",
    ],
    image: "/src/assets/images/ocr.gif",
  },
  {
    target: '[data-tutorial="community"]',
    title: "Ïò®ÎèôÎÑ§",
    icon: "üí¨",
    description:
      "Îã§Î•∏ Î∂ÄÎ™®ÎãòÎì§Í≥º Ï†ïÎ≥¥Î•º Í≥µÏú†ÌïòÍ≥† ÏÜåÌÜµÌï† Ïàò ÏûàÎäî Ïª§ÎÆ§ÎãàÌã∞ Í≥µÍ∞ÑÏûÖÎãàÎã§.",
    example: [
      "üí° Îã§Î•∏ ÏÇ¨ÎûåÎì§Í≥º ÏÜåÌÜµÌï† Ïàò ÏûàÎäî Í≥µÍ∞ÑÏù¥ÏóêÏöî.",
      "üí¨ Ïú°ÏïÑ Í≥†ÎØºÍ≥º Ïú†Ïö©Ìïú Ï†ïÎ≥¥Î•º Í≥µÏú†Ìï¥Î≥¥ÏÑ∏Ïöî.",
      "üéÜ Í≤ΩÌóòÏùÑ ÎÇòÎàÑÍ≥† ÏÑúÎ°ú ÎèÑÏõÄÏùÑ Î∞õÏùÑ Ïàò ÏûàÏñ¥Ïöî.",
    ],
    image: "/src/assets/images/chat.gif",
  },
  {
    target: '[data-tutorial="growth"]',
    title: "ÏÉÅÌô©Î≥Ñ ÌïôÏäµ",
    icon: "üéØ",
    description: "ÏïÑÏù¥Ïùò ÏÉÅÌô©Í≥º ÌïÑÏöîÏóê ÎßûÎäî ÎßûÏ∂§Ìòï ÌïôÏäµ ÏΩòÌÖêÏ∏†Î•º Ï†úÍ≥µÌï©ÎãàÎã§.",
    example: [
      "üí° Îã§ÏñëÌïú ÏÉÅÌô©Ïóê ÎßûÎäî ÌïôÏäµ ÏΩòÌÖêÏ∏†ÏòàÏöî.",
      "üéØ ÌäπÏ†ï ÌÖåÎßàÎ•º ÏßëÏ§ëÏ†ÅÏúºÎ°ú ÌïôÏäµÌï† Ïàò ÏûàÏñ¥Ïöî.",
      "üìà Î∞úÏùå ÌèâÍ∞ÄÎèÑ Ï†úÍ≥µÌï©ÎãàÎã§.",
    ],
    image: "/src/assets/images/learning.gif",
  },
  {
    target: "",
    title: "ÌäúÌÜ†Î¶¨Ïñº Îã§Ïãú Ïû¨ÏÉù",
    icon: "üîÑ",
    description: "ÌäúÌÜ†Î¶¨ÏñºÏùÑ Îã§Ïãú Î≥º Ïàò ÏûàÏäµÎãàÎã§.",
    example: [
      "üí° Ïñ∏Ï†úÎì†ÏßÄ ÌäúÌÜ†Î¶¨ÏñºÏùÑ Îã§Ïãú Î≥º Ïàò ÏûàÏñ¥Ïöî.",
      "üîÑ ÌäúÌÜ†Î¶¨ÏñºÏùò ÎèÑÏõÄÏù¥ ÌïÑÏöîÌïòÎ©¥ Îã§Ïãú ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî.",
      "‚ú® Ïñ∏Ï†úÎÇò Îçî ÎÇòÏùÄ ÏÇ¨Ïö© Í≤ΩÌóòÏùÑ ÏúÑÌï¥ Ï§ÄÎπÑÎêòÏñ¥ ÏûàÏäµÎãàÎã§!",
    ],
    image: "/src/assets/images/retry.gif",
  },
];

const currentStep = ref(0);
const spotlightStyle = ref({});
const currentExampleIndex = ref(0);
let exampleInterval = null;

const currentStepData = computed(() => tutorialSteps[currentStep.value]);

// ÌòÑÏû¨ example ÌÖçÏä§Ìä∏Î•º Î∞òÌôò
const currentExample = computed(() => {
  const examples = currentStepData.value.example;
  if (Array.isArray(examples)) {
    return examples[currentExampleIndex.value];
  }
  return examples; // Î∞∞Ïó¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Í∑∏ÎåÄÎ°ú Î∞òÌôò
});

// ÌïòÏù¥ÎùºÏù¥Ìä∏ Ìö®Í≥º Ï†ÅÏö©/Ï†úÍ±∞
const updateHighlight = async () => {
  await nextTick();

  // Í∏∞Ï°¥ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†úÍ±∞
  const allButtons = document.querySelectorAll("[data-tutorial]");
  allButtons.forEach((btn) => {
    btn.classList.remove("tutorial-highlight");
  });

  const step = tutorialSteps[currentStep.value];
  const targetElement = document.querySelector(step.target);

  console.log("Looking for:", step.target);
  console.log("Found element:", targetElement);

  if (!targetElement) {
    console.log("Element not found!");
    return;
  }

  // ÌòÑÏû¨ Îã®Í≥Ñ Î≤ÑÌäºÏóê ÌïòÏù¥ÎùºÏù¥Ìä∏ ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
  targetElement.classList.add("tutorial-highlight");
};

// example ÏàúÌôò ÏãúÏûë
const startExampleRotation = () => {
  if (exampleInterval) {
    clearInterval(exampleInterval);
  }

  currentExampleIndex.value = 0;
  const examples = currentStepData.value.example;

  if (Array.isArray(examples) && examples.length > 1) {
    exampleInterval = setInterval(() => {
      currentExampleIndex.value =
        (currentExampleIndex.value + 1) % examples.length;
    }, 2000);
  }
};

// example ÏàúÌôò Ï§ëÏßÄ
const stopExampleRotation = () => {
  if (exampleInterval) {
    clearInterval(exampleInterval);
    exampleInterval = null;
  }
};

// Îã§Ïùå Ïä§ÌÖù
const nextStep = () => {
  stopExampleRotation();
  if (currentStep.value < tutorialSteps.length - 1) {
    currentStep.value++;
    updateHighlight();
    startExampleRotation();
  } else {
    closeTutorial();
  }
};

// Ïù¥Ï†Ñ Ïä§ÌÖù
const previousStep = () => {
  stopExampleRotation();
  if (currentStep.value > 0) {
    currentStep.value--;
    updateHighlight();
    startExampleRotation();
  }
};

// ÌäúÌÜ†Î¶¨Ïñº Í±¥ÎÑàÎõ∞Í∏∞
const skipTutorial = () => {
  closeTutorial();
};

// ÌäúÌÜ†Î¶¨Ïñº Îã´Í∏∞
const closeTutorial = () => {
  stopExampleRotation();
  // Î™®Îì† ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†úÍ±∞
  const allButtons = document.querySelectorAll("[data-tutorial]");
  allButtons.forEach((btn) => {
    btn.classList.remove("tutorial-highlight");
  });

  emit("update:modelValue", false);
};

// Î™®Îã¨Ïù¥ Ïó¥Î¶¥ Îïå ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†ÅÏö©
watch(
  () => props.modelValue,
  (newValue) => {
    if (newValue) {
      currentStep.value = 0;
      // Ï¢Ä Îçî Ïó¨Ïú†Î•º ÎëêÍ≥† ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†ÅÏö©
      setTimeout(() => {
        updateHighlight();
        startExampleRotation();
      }, 300);
    } else {
      stopExampleRotation();
    }
  }
);

// ESC ÌÇ§Î°ú ÌäúÌÜ†Î¶¨Ïñº Îã´Í∏∞
onMounted(() => {
  const handleKeydown = (event) => {
    if (event.key === "Escape" && props.modelValue) {
      closeTutorial();
    }
  };

  document.addEventListener("keydown", handleKeydown);

  // Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏ Ïãú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
  const cleanup = () => {
    document.removeEventListener("keydown", handleKeydown);
  };

  return cleanup;
});
</script>

<style>
/* Í∏ÄÎ°úÎ≤å Ïä§ÌÉÄÏùºÎ°ú ÏÑ§Ï†ï */
.tutorial-highlight {
  position: relative;
  animation: tutorialPulse 2s infinite;
  box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.8),
    0 0 20px rgba(147, 51, 234, 0.6) !important;
  border-radius: 16px !important; /* Îçî Îë•Í∏ÄÍ≤å */
  z-index: 45 !important; /* Ïò§Î≤ÑÎ†àÏù¥(z-40) ÏúÑ, Î™®Îã¨(z-50) ÏïÑÎûò */
  background: rgb(
    147 197 253
  ) !important; /* bg-blue-300ÏúºÎ°ú ÏÑ§Ï†ïÌïòÏó¨ Îçî Ïûò Î≥¥Ïù¥Í≤å */
  padding: 6px 16px !important; /* Îçî Í∏∏Í≥† ÎÑìÏùÄ Ìå®Îî© */
  margin: -2px -8px !important; /* ÏùåÏàò ÎßàÏßÑÏúºÎ°ú Îçî ÏûêÏó∞Ïä§ÎüΩÍ≤å ÌôïÏû• */
}

@keyframes tutorialPulse {
  0%,
  100% {
    box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.8),
      0 0 20px rgba(147, 51, 234, 0.6);
  }
  50% {
    box-shadow: 0 0 0 4px rgba(147, 51, 234, 0.6),
      0 0 25px rgba(147, 51, 234, 0.8);
  }
}

/* Ïä§ÏΩîÌîÑÎêú Ïä§ÌÉÄÏùº */
</style>
<style scoped>
/* Ïï†ÎãàÎ©îÏù¥ÏÖò */
@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-slideUp {
  animation: slideUp 0.4s ease;
}
</style>
