# 구글 로그인 실습 (Spring Boot + Vue.js)

## 목표

- 구글 OAuth2 로그인을 통해 사용자 인증
- 스프링 시큐리티가 세션으로 로그인 상태 유지
- 프론트(Vue)가 로그인 버튼 → 사용자 정보 화면까지 연동

## 전체 동작 흐름

1. 사용자가 Vue 프론트 로그인 페이지에서 "구글로 계속하기" 버튼 클릭
2. 브라우저가 Spring Boot 서버의 `/oauth2/authorization/google` 엔드포인트로 이동
3. Spring Security가 구글 로그인 화면으로 리디렉트
4. 로그인 성공 시 세션 생성 후 `/mypage`로 리디렉트
5. Vue의 MyPage.vue 라우트가 렌더링
6. MyPage.vue가 `/mypage` API를 호출해 사용자 정보를 표시

## 구글 OAuth2 콘솔 설정 방법

### 1. Google Cloud Console 접속

- https://console.cloud.google.com/ 로 접속
- 프로젝트 선택 또는 새 프로젝트 생성

### 2. OAuth 동의 화면 설정

---

- 사이드바에서 **API 및 서비스 > OAuth 동의 화면** 선택
- 외부(External) 앱 선택
- 앱 이름, 사용자 지원 이메일, 개발자 이메일 정보 입력
- 승인된 도메인: 로컬 개발 환경에서는 생략 가능
- 테스트 사용자: 본인 구글 계정 이메일 추가 (개발 단계에서 필요)

### 3. OAuth 클라이언트 ID 생성

---

- **API 및 서비스 > 사용자 인증 정보** 메뉴 이동
- **+ 사용자 인증 정보 만들기 > OAuth 클라이언트 ID** 선택
- 애플리케이션 유형: 웹 애플리케이션 선택
- 이름 입력

### 4. 승인된 리디렉션 URI 설정

---

- 승인된 리디렉션 URI 추가
  - 예시 (로컬 개발 환경):
    ```
    http://localhost:8080/login/oauth2/code/google
    ```
- 리디렉션 URI는 Spring Boot가 구글에서 인가 코드를 받을 때 사용하는 콜백 주소

### 5. 클라이언트 ID와 클라이언트 시크릿 확인

---

- 생성 후 클라이언트 ID, 클라이언트 시크릿이 발급됨
- 이 값을 Spring Boot의 application.properties에 등록

### 6. application.properties 추가

---

```properties
예시:
spring.security.oauth2.client.registration.google.client-id=YOUR_GOOGLE_CLIENT_ID
spring.security.oauth2.client.registration.google.client-secret=YOUR_GOOGLE_CLIENT_SECRET
spring.security.oauth2.client.registration.google.scope=openid,profile,email
spring.security.oauth2.client.registration.google.redirect-uri={baseUrl}/login/oauth2/code/{registrationId}
```

## 백엔드(Spring Boot) - 핵심 코드

### 1. SecurityConfig.java

---

Spring Security가 OAuth2 Client로 구글 로그인 플로우를 처리하도록 하고,
로그인 성공 시 세션을 생성해 자동으로 인증 상태를 유지한다.
CORS도 활성화해 Vue 프론트가 쿠키 기반으로 요청할 수 있게 한다.

```java
http
  .cors(withDefaults())
  .authorizeHttpRequests(auth -> auth
      .requestMatchers("/", "/error").permitAll()
      .anyRequest().authenticated()
  )
  .oauth2Login(oauth2 -> oauth2
      .defaultSuccessUrl("/mypage", true)
      .failureUrl("/error")
  )
  .logout(logout -> logout.logoutSuccessUrl("/"));
```

### 2. WebConfig.java

---

Vue 개발 서버(포트 5173)가 백엔드(8080)에 쿠키를 포함해 요청할 수 있도록 CORS를 설정한다.

```java
@Override
public void addCorsMappings(CorsRegistry registry) {
    registry.addMapping("/**")
            .allowedOrigins("http://localhost:5173")
            .allowedMethods("*")
            .allowCredentials(true);
}
```

### 3. UserController.java

---

로그인 완료 후 사용자 정보(Claims)를 프론트로 JSON 형태로 전달하는 REST 엔드포인트를 제공한다.

```java
@GetMapping("/mypage")
public Map<String, Object> mypage(@AuthenticationPrincipal OidcUser oidcUser) {
    return oidcUser.getClaims();
}
```

## 프론트(Vue) - 핵심 코드

### 1. Login.vue

"구글로 계속하기" 버튼을 누르면 백엔드 서버의 OAuth2 로그인 엔드포인트로 브라우저 리다이렉트한다.
브라우저가 Spring 서버 → 구글 로그인 화면으로 이동하는 것이 핵심.
상대 경로가 아닌 서버의 풀 URL을 지정해야 다른 포트로 요청이 간다.

```javascript
onLogin(provider) {
  if (provider === "google") {
    window.location.href = 'http://localhost:8080/oauth2/authorization/google';
  }
}
```

---

### 2. MyPage.vue

로그인 완료 후 사용자가 이동하는 페이지.
마운트되면 백엔드의 `/mypage` API를 호출해 세션 쿠키 기반으로 사용자 정보를 가져온다.
`withCredentials: true` 옵션을 반드시 넣어야 브라우저가 세션 쿠키를 전송한다.

```javascript
mounted() {
  this.fetchUserInfo();
},
methods: {
  fetchUserInfo() {
    axios.get('http://localhost:8080/mypage', { withCredentials: true })
      .then(res => { this.user = res.data; })
      .catch(() => { this.$router.push('/'); });
  }
}
```

---

## 실행 결과 예시

### 1. 로그인 버튼 화면

- Vue 프론트에서 보여주는 소셜 로그인 버튼 UI
- 사용자는 여기서 구글, 네이버, 카카오 중 선택

[로그인 창](./images/0715img1.png)

---

### 2. 구글 계정 선택 화면

- Spring Boot가 구글 OAuth2 엔드포인트로 리디렉트
- 구글 로그인 계정을 선택

[구글 계정 선택 화면](./images/0715img2.png)

---

### 3. 권한 요청 화면

- oauth2-test 애플리케이션이 사용자 이메일, 이름, 사진 공유 권한 요청
- 사용자가 '계속'을 누르면 스프링 서버로 리디렉트되며 로그인 완료

[권한 요청 화면](./images/0715img3.png)

---

### 4. 로그인 후 사용자 정보 화면

- /mypage에서 요총 권환으로 가져온 정보 출력
- 실제 서비스에서는 필요한 정보만 추출해 예쁘게 보여줘야함

[마이페이지 창](./images/0715img4.png)

---

## 정리

- 로그인 버튼 클릭 → 서버의 OAuth2 엔드포인트로 이동
- Spring Security가 구글 로그인 플로우 처리
- 로그인 성공 시 세션 생성
- 프론트가 /mypage로 이동해 사용자 정보 표시
- CORS 설정으로 다른 포트 간 쿠키 포함 요청 허용

---

카카오 네이버 실습은 익일 진행
